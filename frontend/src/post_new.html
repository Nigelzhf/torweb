{% extends "base.html" %}

{% block title %}Tornado.Post.Detail{% end %}

{% block styles %}
<link rel="stylesheet" href="/assets/css/summernote.css">
<link href="/assets/css/font-awesome.min.css" rel="stylesheet">
{% end %}

{% block content %}
    <div class="content-container container post-new-html">
        <div class="post-new-card card custom-card">
             <div class="card-header">
                新主题
            </div>
            <div class="card-block">
                <form data-parsley-validate="" action="/post/add" method="post">
                    <div class="form-group">
                        <label for="title">标题</label>
                        <input type="text" class="form-control" id="title" name="title" placeholder="请输入标题" required>
                    </div>
                    <div class="form-group" style="position: relative;">
                        <label for="topic">主题</label>
                        <input type="text" class="form-control" id="topic" name="topic" placeholder="点击选择主题" required readonly>
                        <div class="card-header-all">
                            <div class="hd">
                                <!-- 这一块其实可以缓存起来, 因为所有用户都是取相同数据 -->
                                {% set len_categorys = len(catetopic['categorys']) %}
                                {% for i in range(len_categorys) %}
                                {% set category = catetopic['categorys'][i] %}
                                {% set topics = catetopic['topics'][i] %}
                                <div class="card-header-all-cate">
                                    <h4>{{category.name}}</h4>
                                    {% for topic in topics %}
                                    <a href="#blank" id="{{topic.str}}">{{topic.name}}</a>
                                    {% end %}
                                </div>
                                {% end %}
                                <div class="card-header-all-cate">
                                    <h4>未分类</h4>
                                    {% for topic in catetopic['topics'][-1] %}
                                    <a href="#blank" id="{{topic.str}}">{{topic.name}}</a>
                                    {% end %}
                                </div>
                             </div>
                        </div>
                    </div>

                        <!-- <select class="form-control" name="topic" id="topic"> -->
                        <!--     {% set len_categorys = len(catetopic['categorys']) %} -->
                        <!--     {% for i in range(len_categorys) %} -->
                        <!--     {% set category = catetopic['categorys'][i] %} -->
                        <!--     {% set topics = catetopic['topics'][i] %} -->
                        <!--     <optgroup label="{{category.name}}"> -->

                        <!--         {% for topic in topics %} -->
                        <!--         <option>{{topic.name}}</option> -->
                        <!--         {% end %} -->
                        <!--     </optgroup> -->
                        <!--     {% end %} -->
                        <!-- </select> -->
                    <div class="form-group">
                        <label for="password">内容</label>
                        <div id="summernote">Please Write Here.</div>
                        <input name="content" style="display:none;"/>
                    </div>
                    <div class="form-group float-left">
                        <img class="emoji" id="emoji-btn" src="/static/images/emoji/basic/smile.png">
                        <ul id="emoji-list" class="emojis list-inline" style="display: none;">
                        </ul>
                    </div>
                    <button type="submit" class="btn btn-primary float-right">提交</button>
                </form>
            </div>
        </div>
    </div>
{% end %}

{% block scripts %}
<script src="/assets/js/bootstrap.min.js"></script>
<script src="/assets/js/summernote.js"></script>
<script src="/assets/js/i18n/summernote-zh-CN.js"></script>
<script type="text/javascript">
$(document).ready(function () {
    var topic = '';
    $('#summernote').summernote({
        lang: 'zh-CN',
        height: 300,                 // set editor height
        minHeight: null,             // set minimum height of editor
        maxHeight: null,             // set maximum height of editor
        focus: true,                  // set focus to editable area after initializing summernote
        toolbar: [
            ['sytle',['style','bold','italic','underline','color','fontsize']],
            ['para',['ol','ul','paragraph']],
            ['insert',['picture','link','table']],
            ['misc', ['codeview']]
        ]
    });
    $('form').on('submit', function (event) {
        event.preventDefault();
         $.ajax({
            type: 'post',
            dataType: 'json',
            url: '/post/add',
            data: {
                'title': $('#title').val(),
                'topic': topic,
                'content': $('#summernote').summernote('code')
            },
            success: function(result, status) {
                if(result.errorcode == 0) {
                    window.location.href="/post/"+result.data['post_id'];
                }
                else if(result.errorcode == 1) {
                    alert(result.txt);
                }
            }
        })
        return 1;
    });
    $(".post-new-html .card-header-all-cate a").on('click', function(e){
        $("#topic").val($(this).html());
        topic = $(this).attr('id');
    });
    post_new_show_hide_cate();
    show_hide_emoji_list();
    load_emoji_summernote();
});
</script>
{% end %}
